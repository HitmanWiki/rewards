<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATM Rewards Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .skeleton {
            background-color: #374151;
            -webkit-mask: linear-gradient(90deg, transparent, #374151, transparent);
            mask: linear-gradient(90deg, transparent, #374151, transparent);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite linear;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.5s forwards, fadeOut 0.5s forwards 3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-inter">
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const Notification = ({ message, type }) => (
            <div className={`notification p-4 rounded-md shadow-lg ${type === 'success' ? 'bg-green-800 border-green-700' : 'bg-red-800 border-red-700'}`}>
                <div className="flex items-center">
                    {type === 'success' ? (
                        <i className="fas fa-check-circle mr-2"></i>
                    ) : (
                        <i className="fas fa-exclamation-circle mr-2"></i>
                    )}
                    <span>{message}</span>
                </div>
            </div>
        );

        const RewardsComponent = () => {
            // State variables
            const [provider, setProvider] = useState(null);
            const [signer, setSigner] = useState(null);
            const [userAddress, setUserAddress] = useState('');
            const [atmBalance, setAtmBalance] = useState('');
            const [rewardBalance, setRewardBalance] = useState('');
            const [unclaimedRewards, setUnclaimedRewards] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [atmContract, setAtmContract] = useState(null);
            const [rewardContract, setRewardContract] = useState(null);
            const [rewardTokenName, setRewardTokenName] = useState('');
            const [rewardTokenSymbol, setRewardTokenSymbol] = useState('');
            const [rewardTokenDecimals, setRewardTokenDecimals] = useState(18);
            const [pendingRewards, setPendingRewards] = useState(0);
            const [claimedRewards, setClaimedRewards] = useState(0);
            const [nextClaimTime, setNextClaimTime] = useState(0);
            const [walletProviderType, setWalletProviderType] = useState(null);
            const [walletConnectProvider, setWalletConnectProviderInstance] = useState(null); // Hold the instance

            // Contract details
            const atmABI = [
                "function balanceOf(address account) external view returns (uint256)",
                "function decimals() external view returns (uint8)",
                "function getUnpaidEarnings(address account) external view returns (uint256)",
                "function _claimDividend() external",
                "function totalRewardsDistributed(address account) external view returns (uint256)",
                "function getNextClaimTime(address account) external view returns (uint256)"
            ];

            const rewardTokenABI = [
                "function name() external view returns (string memory)",
                "function symbol() external view returns (string memory)",
                "function balanceOf(address account) external view returns (uint256)",
                "function decimals() external view returns (uint8)"
            ];

            const atmContractAddress = '0x88807fDabF60fdDd7bd8fB4987dC5A63cbd31f6a';
            const rewardTokenAddress = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
            const infuraId = 'YOUR_INFURA_ID'; // Replace with your actual Infura ID or another RPC provider

            // Add notification helper
            const addNotification = (message, type = 'success') => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== id));
                }, 3500);
            };

            // Connect with MetaMask
            const connectMetaMask = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    if (!window.ethereum) {
                        throw new Error('MetaMask not detected. Please install the extension.');
                    }

                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const ethersProvider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = ethersProvider.getSigner();
                    const address = await signer.getAddress();

                    setProvider(ethersProvider);
                    setSigner(signer);
                    setUserAddress(address);
                    setWalletProviderType('metamask');

                    // Initialize contracts
                    const atm = new ethers.Contract(atmContractAddress, atmABI, signer);
                    const reward = new ethers.Contract(rewardTokenAddress, rewardTokenABI, signer);

                    setAtmContract(atm);
                    setRewardContract(reward);

                    // Get token info
                    const [name, symbol, decimals] = await Promise.all([
                        reward.name(),
                        reward.symbol(),
                        reward.decimals()
                    ]);

                    setRewardTokenName(name);
                    setRewardTokenSymbol(symbol);
                    setRewardTokenDecimals(decimals);

                    // Set up event listeners
                    window.ethereum.on("accountsChanged", (accounts) => {
                        setUserAddress(accounts[0]);
                    });

                    window.ethereum.on("chainChanged", () => {
                        window.location.reload();
                    });

                    addNotification('MetaMask connected successfully');

                    // Load initial data
                    await fetchData(atm, reward, address, decimals);

                } catch (error) {
                    console.error("MetaMask connection error:", error);
                    setError(error.message);
                    addNotification(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Connect with WalletConnect
            const connectWalletConnect = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    // Use a direct script import and access the global object
                    const provider = new window.WalletConnectProvider.default({
                        rpc: {
                            8453: `https://base-mainnet.infura.io/v3/${infuraId}`,
                            1: `https://mainnet.infura.io/v3/${infuraId}`
                        },
                        bridge: 'https://bridge.walletconnect.org',
                        qrcodeModalOptions: {
                            open: (uri, cb) => {
                                console.log("WalletConnect URI:", uri);
                                addNotification('Scan QR code with your wallet app');
                            },
                            close: () => { },
                        },
                    });


                    setWalletConnectProviderInstance(provider);

                    // Enable session
                    await provider.enable();

                    const ethersProvider = new ethers.providers.Web3Provider(provider);
                    const signer = ethersProvider.getSigner();
                    const address = await signer.getAddress();

                    setProvider(ethersProvider);
                    setSigner(signer);
                    setUserAddress(address);
                    setWalletProviderType('walletconnect');

                    // Initialize contracts
                    const atm = new ethers.Contract(atmContractAddress, atmABI, signer);
                    const reward = new ethers.Contract(rewardTokenAddress, rewardTokenABI, signer);

                    setAtmContract(atm);
                    setRewardContract(reward);

                    // Get token info
                    const [name, symbol, decimals] = await Promise.all([
                        reward.name(),
                        reward.symbol(),
                        reward.decimals()
                    ]);

                    setRewardTokenName(name);
                    setRewardTokenSymbol(symbol);
                    setRewardTokenDecimals(decimals);

                    // Set up event listeners
                    provider.on('accountsChanged', (accounts) => {
                        setUserAddress(accounts[0]);
                    });

                    provider.on('chainChanged', () => {
                        window.location.reload();
                    });

                    provider.on('disconnect', () => {
                        disconnectWallet();
                    });

                    addNotification('WalletConnect connected successfully.');
                    await fetchData(atm, reward, address, decimals);
                } catch (error) {
                    console.error('WalletConnect Error:', error);
                    setError(error.message);
                    addNotification(error.message, 'error');
                    setLoading(false);
                } finally {
                    setLoading(false);
                }
            };

            // Disconnect wallet
            const disconnectWallet = async () => {
                try {
                    if (walletProviderType === 'walletconnect' && walletConnectProviderInstance) {
                        await walletConnectProviderInstance.disconnect();
                    }
                    setWalletConnectProviderInstance(null);
                    setProvider(null);
                    setSigner(null);
                    setUserAddress('');
                    setAtmContract(null);
                    setRewardContract(null);
                    setWalletProviderType(null);

                    addNotification('Wallet disconnected');
                } catch (err) {
                    console.error("Disconnect error:", err);
                    setError("Failed to disconnect wallet");
                    addNotification("Failed to disconnect wallet", 'error');
                }
            };

            // Fetch contract data
            const fetchData = async (atm, reward, address, decimals) => {
                try {
                    setLoading(true);

                    const [
                        atmBal,
                        rewardBal,
                        rewards,
                        claimed,
                        nextClaim
                    ] = await Promise.all([
                        atm.balanceOf(address),
                        reward.balanceOf(address),
                        atm.getUnpaidEarnings(address).catch(() => ethers.BigNumber.from(0)),
                        atm.totalRewardsDistributed(address).catch(() => ethers.BigNumber.from(0)),
                        atm.getNextClaimTime(address).catch(() => ethers.BigNumber.from(0))
                    ]);

                    setAtmBalance(ethers.utils.formatUnits(atmBal, await atm.decimals()));
                    setRewardBalance(ethers.utils.formatUnits(rewardBal, decimals));
                    setUnclaimedRewards(ethers.utils.formatUnits(rewards, decimals));
                    setPendingRewards(ethers.utils.formatUnits(rewards, decimals));
                    setClaimedRewards(ethers.utils.formatUnits(claimed, decimals));
                    setNextClaimTime(nextClaim.toNumber());

                } catch (err) {
                    console.error("Data fetch error:", err);
                    setError("Failed to fetch data");
                    addNotification("Failed to fetch data", 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Claim rewards
            const handleClaimRewards = async () => {
                if (!atmContract) return;

                try {
                    setLoading(true);
                    const tx = await atmContract._claimDividend();
                    addNotification('Transaction submitted. Waiting for confirmation...');

                    await tx.wait();
                    addNotification(`Successfully claimed ${unclaimedRewards} ${rewardTokenSymbol}!`);

                    // Refresh data
                    if (atmContract && rewardContract && userAddress) {
                        await fetchData(atmContract, rewardContract, userAddress, rewardTokenDecimals);
                    }
                } catch (err) {
                    console.error("Claim error:", err);
                    setError(err.message || "Failed to claim rewards");
                    addNotification(err.message || "Failed to claim rewards", 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Check if already connected on page load
            useEffect(() => {
                const checkConnection = async () => {
                    if (window.ethereum && window.ethereum.selectedAddress) {
                        await connectMetaMask();
                    }
                    //  Attempt to use WalletConnect if it was previously connected
                    //  This is important for persistence across page reloads
                    if (typeof window !== 'undefined' && window.localStorage.getItem('walletconnect')) {
                        await connectWalletConnect();
                    }
                };
                checkConnection();
            }, []);

            return (
                <div className="min-h-screen bg-gray-900 text-white p-4 sm:p-8">
                    {/* Notifications */}
                    {notifications.map(notification => (
                        <Notification key={notification.id} message={notification.message} type={notification.type} />
                    ))}

                    <div className="max-w-4xl mx-auto space-y-6">
                        <h1 className="text-3xl sm:text-4xl font-bold text-center bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text">
                            ATM Rewards Dashboard
                        </h1>

                        {error && (
                            <div className="bg-red-900/90 border-red-700 text-red-200 p-4 rounded-md mb-4">
                                <p className="text-red-400">{error}</p>
                            </div>
                        )}

                        {!userAddress ? (
                            <div className="flex flex-col sm:flex-row justify-center items-center gap-4">
                                <button
                                    onClick={connectMetaMask}
                                    className="bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 px-6 rounded-md hover:from-blue-600 hover:to-purple-600 transition-colors shadow-lg hover:shadow-xl flex items-center"
                                >
                                    <i className="fab fa-ethereum mr-2"></i>Connect MetaMask
                                </button>
                                <button
                                    onClick={connectWalletConnect}
                                    className="bg-gradient-to-r from-green-500 to-teal-500 text-white py-3 px-6 rounded-md hover:from-green-600 hover:to-teal-600 transition-colors shadow-lg hover:shadow-xl flex items-center"
                                >
                                    <i className="fas fa-wallet mr-2"></i>Connect WalletConnect
                                </button>
                                {error && error.includes("WalletConnect") && (
                                    <div className="text-red-400 mt-2 text-center">
                                        <p>Having trouble connecting with WalletConnect?</p>
                                        <ul className="list-disc pl-5">
                                            <li>Check your internet connection.</li>
                                            <li>Ensure your wallet app is running and supports WalletConnect.</li>
                                            <li>Try again in a few minutes, as the WalletConnect bridge might be temporarily unavailable.</li>
                                            <li>If the problem persists, try connecting with MetaMask.</li>
                                        </ul>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="text-center">
                                <button
                                    onClick={disconnectWallet}
                                    className="bg-gray-700 hover:bg-gray-600 text-white py-3 px-6 rounded-md transition-colors shadow-lg flex items-center mx-auto"
                                >
                                    <i className="fas fa-sign-out-alt mr-2"></i>Disconnect Wallet
                                </button>
                            </div>
                        )}

                        {loading && userAddress && (
                            <div className="space-y-4">
                                <div className="skeleton h-10 w-full rounded-md"></div>
                                <div className="skeleton h-8 w-3/4 rounded-md"></div>
                                <div className="skeleton h-8 w-3/4 rounded-md"></div>
                                <div className="skeleton h-12 w-full rounded-md"></div>
                            </div>
                        )}

                        {userAddress && !loading && (
                            <div className="space-y-6">
                                <div className="bg-gray-800 border-gray-700 shadow-lg rounded-md p-6">
                                    <h2 className="text-xl sm:text-2xl font-semibold text-white mb-4">
                                        Wallet Information
                                    </h2>
                                    <div className="text-gray-300 space-y-2">
                                        <div>
                                            <span className="font-medium">Your Address:</span>
                                            <span className="font-mono text-sm break-all ml-2 text-gray-400">{userAddress}</span>
                                        </div>
                                        <div>
                                            <span className="font-medium">ATM Balance:</span>
                                            <span className="ml-2 text-green-400">{atmBalance} ATM</span>
                                        </div>
                                        <div>
                                            <span className="font-medium">{rewardTokenName} Balance:</span>
                                            <span className="ml-2 text-blue-400">{rewardBalance} {rewardTokenSymbol}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-800 border-gray-700 shadow-lg rounded-md p-6">
                                    <h2 className="text-xl sm:text-2xl font-semibold text-white mb-4">
                                        Rewards
                                    </h2>
                                    <div className="text-gray-300 space-y-4">
                                        <div>
                                            <span className="font-medium">Unclaimed Rewards:</span>
                                            <span className={Number(unclaimedRewards) > 0 ? "ml-2 text-yellow-400" : "ml-2 text-gray-400"}>
                                                {Number(unclaimedRewards) > 0 ? unclaimedRewards : '0'} {rewardTokenSymbol}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="font-medium">Pending Rewards:</span>
                                            <span className="ml-2 text-yellow-400">
                                                {pendingRewards} {rewardTokenSymbol}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="font-medium">Claimed Rewards:</span>
                                            <span className="ml-2 text-green-400">
                                                {claimedRewards} {rewardTokenSymbol}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="font-medium">Next Claim Time:</span>
                                            <span className={nextClaimTime > 0 ? "ml-2 text-red-400" : "ml-2 text-gray-400"}>
                                                {nextClaimTime > 0
                                                    ? new Date(nextClaimTime * 1000).toLocaleString()
                                                    : "Ready to Claim"}
                                            </span>
                                        </div>
                                        <button
                                            onClick={handleClaimRewards}
                                            disabled={loading || Number(unclaimedRewards) <= 0 || nextClaimTime > Date.now() / 1000}
                                            className={`w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white py-3 sm:py-4
                                                rounded-md hover:from-purple-600 hover:to-blue-600 transition-colors
                                                disabled:opacity-50 disabled:cursor-not-allowed
                                                shadow-lg hover:shadow-xl flex items-center justify-center`}
                                        >
                                            {loading ? (
                                                <>
                                                    <i className="fas fa-spinner fa-spin mr-2"></i>
                                                    Processing...
                                                </>
                                            ) : (
                                                `Claim ${unclaimedRewards} ${rewardTokenSymbol}`
                                            )}
                                        </button>
                                        <div className="text-gray-400 text-sm">
                                            <span className="font-medium">Note:</span> Rewards are distributed in {rewardTokenName} ({rewardTokenSymbol}).
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<RewardsComponent />, document.getElementById('root'));
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
</body>

</html>